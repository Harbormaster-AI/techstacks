########################################################################
## JFrog_Pipelines Macros
########################################################################

########################################################################
## JFrog_Pipelines_Build_Step - Implement for the common stack
########################################################################
#macro( JFrog_Pipelines_Build_Step )
      # ======================================================= 
      # Maven Build Step
      # =======================================================    
      - name:                             maven_build_step    # Unique name <required>
        type:                             MvnBuild            # build type <required>  
        
        # ======================================================= 
        # Step configuration
        # ======================================================= 
        configuration:      
        
          autoPublishBuildInfo:           true                # Publishes build info to Artifactory. Requires a BuildInfo resources in the outputResources list. Default is false.
          sourceLocation:                 .                   # The source code starts at the root directory
          mvnCommand:                     clean package       # Tells Maven to perform a clean then package the app
          forceXrayScan:                  true                # Forces an Xray scan after publishing to Artifactory
          failOnScan:                     true                # When set to  true, and  when the Xray Policy RuleFail Build  checkbox is checked, a failed Xray scan will result in a failure of the step
          deployerReleaseRepo:            ${buildArtifactRepo}    # Snapshot artifacts created by the MvnBuild are uploaded to this Artifactory repository
          deployerSnapshotRepo:           ${buildArtifactRepo}    # Release artifacts created by the MvnBuild are uploaded to this Artifactory repository.
          affinityGroup:                  shared_affinity_group # used to bind steps <optional>
          
          outputResources:
            - name:                       maven_build_info  # Uses the defined Maven build info resource               
          
          inputResources:
            - name:                       git_repo         # Use the git_repo resource   
         
          environmentVariables:
              skipTests:                  "true"                # Determines if testing should be skipped or invoked during Maven packaging
              DATABASE_URL:               ${databaseUrl}        # if skipTests set to false, make sure the host name or ip address to running MySQL instance
              
          integrations:
            - name:                       ${buildArtifactIntegration}  # Must specify an Artifactory Integration <required>  
        
        execution:
          
          onStart:
            - echo "Preparing for build using Maven..."

          onSuccess:                       # preserve test results
            - mkdir -p jfrog_pipelines/testresults
            - find . -type f -regex ".*/target/surefire-reports/.*xml" -exec cp {} jfrog_pipelines/testresults/ \;
            
#end##macro( JFrog_Pipelines_Build_Step )

